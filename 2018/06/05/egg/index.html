<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>egg入门 | hello2dj | if you can&#39;t explain it simply, you don&#39;t understand it well enough</title>

  
  <meta name="author" content="hello2dj (dj_amazing@sina.com)">
  

  
  <meta name="description" content="每个人都是带着棱角来到世上，只有磨平棱角才能走的更远">
  

  
  
  <meta name="keywords" content="node">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="egg入门"/>

  <meta property="og:site_name" content="hello2dj"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="hello2dj" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
</head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">hello2dj</a>
    </h1>
    <p class="site-description">if you can&#39;t explain it simply, you don&#39;t understand it well enough</p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">Home</a></li>
      
        <li><a href="/archives">Archives</a></li>
      
        <li><a href="/categories">Categories</a></li>
      
        <li><a href="/tags">Tags</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>egg入门</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/06/05/egg/" rel="bookmark">
        <time class="entry-date published" datetime="2018-06-05T02:05:27.000Z">
          2018-06-05
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="egg是基于koa的企业级web框架"><a href="#egg是基于koa的企业级web框架" class="headerlink" title="egg是基于koa的企业级web框架"></a>egg是基于koa的企业级web框架</h1><h2 id="egg的使用感觉"><a href="#egg的使用感觉" class="headerlink" title="egg的使用感觉"></a>egg的使用感觉</h2><ol>
<li>约定大于配置</li>
<li>koa中间件基本无痛使用</li>
<li>可以总结业务通用基础服务（生产基础框架），而不用费心费力再重新写插件啥的<blockquote>
<p>app -&gt; plugins -&gt; framework (统统一套约定)</p>
</blockquote>
</li>
</ol>
<blockquote>
<p><a href="http://eggjs.org/zh-cn" target="_blank" rel="noopener">照着官网总结了一部分详细的还得去官网查询</a></p>
</blockquote>
<h3 id="官方文档进行搭建"><a href="#官方文档进行搭建" class="headerlink" title="官方文档进行搭建"></a>官方文档进行搭建</h3><ol>
<li>npm i egg-init -g</li>
<li>egg-init egg-example –type=simple<blockquote>
<p>关于 type: egg 本身的集成包括了很多的东西，从一个基本的webserver走起，沉淀出plugin, 最后是framework 于是type就很明显了webserver== simple…</p>
</blockquote>
</li>
</ol>
<h3 id="整体结构-MVC"><a href="#整体结构-MVC" class="headerlink" title="整体结构 MVC"></a>整体结构 MVC</h3><h3 id="文件夹约定"><a href="#文件夹约定" class="headerlink" title="文件夹约定"></a>文件夹约定</h3><p>所有相应的文件必须放在指定目录中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">egg-project</span><br><span class="line">├── package.json</span><br><span class="line">├── app.js (可选)</span><br><span class="line">├── agent.js (可选)</span><br><span class="line">├── app</span><br><span class="line">|   ├── router.js</span><br><span class="line">│   ├── controller</span><br><span class="line">│   |   └── home.js</span><br><span class="line">│   ├── service (可选)</span><br><span class="line">│   |   └── user.js</span><br><span class="line">│   ├── middleware (可选)</span><br><span class="line">│   |   └── response_time.js</span><br><span class="line">│   ├── schedule (可选)</span><br><span class="line">│   |   └── my_task.js</span><br><span class="line">│   ├── public (可选)</span><br><span class="line">│   |   └── reset.css</span><br><span class="line">│   ├── view (可选)</span><br><span class="line">│   |   └── home.tpl</span><br><span class="line">│   └── extend (可选)</span><br><span class="line">│       ├── helper.js (可选)</span><br><span class="line">│       ├── request.js (可选)</span><br><span class="line">│       ├── response.js (可选)</span><br><span class="line">│       ├── context.js (可选)</span><br><span class="line">│       ├── application.js (可选)</span><br><span class="line">│       └── agent.js (可选)</span><br><span class="line">├── config</span><br><span class="line">|   ├── plugin.js</span><br><span class="line">|   ├── config.default.js</span><br><span class="line">│   ├── config.prod.js</span><br><span class="line">|   ├── config.test.js (可选)</span><br><span class="line">|   ├── config.local.js (可选)</span><br><span class="line">|   └── config.unittest.js (可选)</span><br><span class="line">└── test</span><br><span class="line">    ├── middleware</span><br><span class="line">    |   └── response_time.test.js</span><br><span class="line">    └── controller</span><br><span class="line">        └── home.test.js</span><br></pre></td></tr></table></figure>
<h3 id="内置对象"><a href="#内置对象" class="headerlink" title="内置对象"></a><a href="http://eggjs.org/zh-cn/basics/objects.html" target="_blank" rel="noopener">内置对象</a></h3><ol>
<li>Application (ctx.app, this.app)</li>
<li>Response/Request (ctx.request, ctx.response)</li>
<li>Context (this.ctx)</li>
<li>Service (this.service)`</li>
<li>Helper (this.ctx.helper)</li>
<li>Logger (ctx.logger, this.logger（应用打印log）) 还有coreLogger(框架打印log)</li>
<li>Config (this.config, app.config)</li>
<li>Subscription 订阅发布模型的规范基类</li>
</ol>
<h3 id="controller"><a href="#controller" class="headerlink" title="controller"></a>controller</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">// app/controller/post.js</span><br><span class="line">const Controller = require(&apos;egg&apos;).Controller;</span><br><span class="line">class PostController extends Controller &#123;</span><br><span class="line">  async create() &#123;</span><br><span class="line">    const &#123; ctx, service &#125; = this;</span><br><span class="line">    const createRule = &#123;</span><br><span class="line">      title: &#123; type: &apos;string&apos; &#125;,</span><br><span class="line">      content: &#123; type: &apos;string&apos; &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">    // 校验参数</span><br><span class="line">    ctx.validate(createRule);</span><br><span class="line">    // 组装参数</span><br><span class="line">    const author = ctx.session.userId;</span><br><span class="line">    const req = Object.assign(ctx.request.body, &#123; author &#125;);</span><br><span class="line">    // 调用 Service 进行业务处理</span><br><span class="line">    const res = await service.post.create(req);</span><br><span class="line">    // 设置响应内容和响应状态码</span><br><span class="line">    ctx.body = &#123; id: res.id &#125;;</span><br><span class="line">    ctx.status = 201;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">module.exports = PostController;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>this.ctx: 当前请求的上下文 Context 对象的实例，通过它我们可以拿到框架封装好的处理当前请求的各种便捷属性和方法。</p>
</li>
<li><p>this.app: 当前应用 Application 对象的实例，通过它我们可以拿到框架提供的全局对象和方法。</p>
</li>
<li><p>this.service：应用定义的 Service，通过它我们可以访问到抽象出的业务层，等价于 this.ctx.service 。</p>
</li>
<li><p>this.config：应用运行时的配置项。</p>
</li>
<li><p>this.logger：logger 对象，上面有四个方法（debug，info，warn，error），分别代表打印四个不同级别的日志，使用方法和效果与 context logger 中介绍的一样，但是通过这个 logger 对象记录的日志，在日志前面会加上打印该日志的文件路径，以便快速定位日志打印位置。</p>
</li>
</ul>
<h3 id="service"><a href="#service" class="headerlink" title="service"></a>service</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// app/service/user.js</span><br><span class="line">const Service = require(&apos;egg&apos;).Service;</span><br><span class="line"></span><br><span class="line">class UserService extends Service &#123;</span><br><span class="line">  async find(uid) &#123;</span><br><span class="line">    const user = await this.ctx.db.query(&apos;select * from user where uid = ?&apos;, uid);</span><br><span class="line">    return user;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module.exports = UserService;</span><br></pre></td></tr></table></figure>
<p>this对象和controller中能拿到的实例是相同的, service的使用是依据文件名来查找的，this.service.filename.method</p>
<p>service 在使用构造函数时需要传递ctx参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">class User extends app.Service &#123;</span><br><span class="line">  // 默认不需要提供构造函数。</span><br><span class="line">  // constructor(ctx) &#123;</span><br><span class="line">  //   super(ctx); 如果需要在构造函数做一些处理，一定要有这句话，才能保证后面 `this.ctx`的使用。</span><br><span class="line">  //   // 就可以直接通过 this.ctx 获取 ctx 了</span><br><span class="line">  //   // 还可以直接通过 this.app 获取 app 了</span><br><span class="line">  // &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="router"><a href="#router" class="headerlink" title="router"></a>router</h3><p><a href="http://eggjs.org/zh-cn/basics/router.html" target="_blank" rel="noopener">http://eggjs.org/zh-cn/basics/router.html</a></p>
<p>基本使用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// app/router.js</span><br><span class="line">module.exports = app =&gt; &#123;</span><br><span class="line">  const &#123; router, controller &#125; = app;</span><br><span class="line">  router.get(&apos;/user/:id&apos;, controller.user.info);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h3 id="middlerware"><a href="#middlerware" class="headerlink" title="middlerware"></a>middlerware</h3><p>基本示例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">const isJSON = require(&apos;koa-is-json&apos;);</span><br><span class="line">const zlib = require(&apos;zlib&apos;);</span><br><span class="line"></span><br><span class="line">async function gzip(ctx, next) &#123;</span><br><span class="line">  await next();</span><br><span class="line"></span><br><span class="line">  // 后续中间件执行完成后将响应体转换成 gzip</span><br><span class="line">  let body = ctx.body;</span><br><span class="line">  if (!body) return;</span><br><span class="line">  if (isJSON(body)) body = JSON.stringify(body);</span><br><span class="line"></span><br><span class="line">  // 设置 gzip body，修正响应头</span><br><span class="line">  const stream = zlib.createGzip();</span><br><span class="line">  stream.end(body);</span><br><span class="line">  ctx.body = stream;</span><br><span class="line">  ctx.set(&apos;Content-Encoding&apos;, &apos;gzip&apos;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>使用</p>
<ol>
<li><p>全局路由使用<br>module.exports = {<br>// 配置需要的中间件，数组顺序即为中间件的加载顺序<br>middleware: [ ‘gzip’ ],</p>
<p>// 配置 gzip 中间件的配置<br>gzip: {<br> threshold: 1024, // 小于 1k 的响应体不压缩<br>},<br>};</p>
</li>
<li><p>某个路由使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">module.exports = app =&gt; &#123;</span><br><span class="line">  const gzip = app.middleware.gzip(&#123; threshold: 1024 &#125;);</span><br><span class="line">  app.router.get(&apos;/needgzip&apos;, gzip, app.controller.handler);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>框架默认中间件使用<br>例如，想把某个自定义中间件放到所有中间件之前执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// app.js</span><br><span class="line">module.exports = app =&gt; &#123;</span><br><span class="line">  // 在中间件最前面统计请求时间</span><br><span class="line">  app.config.coreMiddleware.unshift(&apos;report&apos;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>上面的顺序可随意互换</p>
<ol start="4">
<li><a href="http://eggjs.org/zh-cn/basics/middleware.html#%E4%BD%BF%E7%94%A8-koa-%E7%9A%84%E4%B8%AD%E9%97%B4%E4%BB%B6" target="_blank" rel="noopener">koa中间件基本可无痛使用</a></li>
</ol>
<p>通用配置（无论是框架还是自定义中间件都可以）</p>
<ol>
<li>enable：控制中间件是否开启。</li>
<li>match：设置只有符合某些规则的请求才会经过这个中间件。</li>
<li>ignore：设置符合某些规则的请求不经过这个中间件。</li>
</ol>
<h3 id="插件（就是个mini的egg应用，只是没有路由和controller罢了）"><a href="#插件（就是个mini的egg应用，只是没有路由和controller罢了）" class="headerlink" title="插件（就是个mini的egg应用，只是没有路由和controller罢了）"></a>插件（就是个mini的egg应用，只是没有路由和controller罢了）</h3><p><a href="http://eggjs.org/zh-cn/advanced/plugin.html" target="_blank" rel="noopener">http://eggjs.org/zh-cn/advanced/plugin.html</a></p>
<p>可以把我们的通用逻辑沉淀为插件</p>
<p>插件配置<br>示例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">exports.mongoose = &#123;</span><br><span class="line">    enable: true,</span><br><span class="line">    package: &apos;egg-mongoose&apos;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">exports.session = false;</span><br><span class="line"></span><br><span class="line">exports.cors = &#123;</span><br><span class="line">    enable: true,</span><br><span class="line">    package: &apos;egg-cors&apos;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">exports.jwt = &#123;</span><br><span class="line">    enable: true,</span><br><span class="line">    package: &apos;egg-jwt&apos;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">exports.routerPlus = &#123;</span><br><span class="line">    enable: true,</span><br><span class="line">    package: &apos;egg-router-plus&apos;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h3 id="定时任务"><a href="#定时任务" class="headerlink" title="定时任务"></a>定时任务</h3><p><a href="http://eggjs.org/zh-cn/basics/schedule.html" target="_blank" rel="noopener">http://eggjs.org/zh-cn/basics/schedule.html</a></p>
<h3 id="框架扩展"><a href="#框架扩展" class="headerlink" title="框架扩展"></a>框架扩展</h3><ol>
<li>context</li>
<li>application</li>
<li>response</li>
<li>request</li>
<li>helper<br>扩展就是说可以通过context等实例直接访问到<br>例如，我们要增加一个 ctx.foo() 方法：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// app/extend/context.js</span><br><span class="line">module.exports = &#123;</span><br><span class="line">  foo(param) &#123;</span><br><span class="line">    // this 就是 ctx 对象，在其中可以调用 ctx 上的其他方法，或访问属性</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>特性根据环境进行框架扩展<br>比如unittest环境app实例有mockXX方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// app/extend/application.unittest.js</span><br><span class="line">module.exports = &#123;</span><br><span class="line">  mockXX(k, v) &#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h3 id="启动自定义-可以执行一些异步初始化的工作"><a href="#启动自定义-可以执行一些异步初始化的工作" class="headerlink" title="启动自定义(可以执行一些异步初始化的工作)"></a>启动自定义(可以执行一些异步初始化的工作)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">module.exports = app =&gt; &#123;</span><br><span class="line">  app.beforeStart(async () =&gt; &#123;</span><br><span class="line">    // 应用会等待这个函数执行完成才启动</span><br><span class="line">    app.cities = await app.curl(&apos;http://example.com/city.json&apos;, &#123;</span><br><span class="line">      method: &apos;GET&apos;,</span><br><span class="line">      dataType: &apos;json&apos;,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    // 也可以通过以下方式来调用 Service</span><br><span class="line">    // const ctx = app.createAnonymousContext();</span><br><span class="line">    // app.cities = await ctx.service.cities.load();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>基本默认<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">config</span><br><span class="line">|- config.default.js</span><br><span class="line">|- config.test.js</span><br><span class="line">|- config.prod.js</span><br><span class="line">|- config.unittest.js</span><br><span class="line">`- config.local.js</span><br></pre></td></tr></table></figure></p>
<p>配置加载顺序<br>-&gt; 插件 config.default.js<br>-&gt; 框架 config.default.js<br>-&gt; 应用 config.default.js<br>-&gt; 插件 config.prod.js<br>-&gt; 框架 config.prod.js<br>-&gt; 应用 config.prod.js</p>
<p>配置示例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">module.exports = appInfo =&gt; &#123;</span><br><span class="line">    appInfo;</span><br><span class="line">    const config = exports = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    // add your config here</span><br><span class="line">    config.middleware = [&apos;errorhandler&apos;, &apos;auth&apos;];</span><br><span class="line">    config.auth = &#123;</span><br><span class="line">        ignore: []</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    // mongoose</span><br><span class="line">    config.mongoose = &#123;</span><br><span class="line">        url: &apos;mongodb://localhost:27017/trace-to-source&apos;,</span><br><span class="line">        options: &#123;&#125;,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    // multipart set</span><br><span class="line">    config.multipart = &#123;</span><br><span class="line">        fileSize: &apos;30mb&apos;,</span><br><span class="line">        whitelist: [</span><br><span class="line">            &apos;.xlsx&apos;,</span><br><span class="line">            &apos;.jpg&apos;,</span><br><span class="line">            &apos;.png&apos;,</span><br><span class="line">            &apos;.zip&apos;,</span><br><span class="line">        ],</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    config.security = &#123; // 关闭csrf安全防范(关闭后post delete put请求可以不携带csrf-token)</span><br><span class="line">        domainWhiteList: [&apos;http://47.104.6.246:8090&apos;, &apos;http://localhost:8000&apos;, &apos;https://localhost:8000&apos;],</span><br><span class="line">        csrf: &#123;</span><br><span class="line">            enable: false,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    // cors</span><br><span class="line">    config.cors = &#123;</span><br><span class="line">        credentials: true,</span><br><span class="line">        allowMethods: &apos;GET,HEAD,PUT,POST,DELETE,PATCH,OPTIONS&apos;,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    // logger</span><br><span class="line">    config.logger = &#123;</span><br><span class="line">        buffer: true, // 文件写入时缓存 https://github.com/eggjs/egg-logger/blob/master/lib/egg/loggers.js#L44</span><br><span class="line">        maxDays: 0,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    config.jwt = &#123;</span><br><span class="line">        secret: &apos;lksjdhglaiejf&apos;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    return config;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h3 id="运行环境"><a href="#运行环境" class="headerlink" title="运行环境"></a>运行环境</h3><ol>
<li>通过 config/env 文件指定，该文件的内容就是运行环境，如 prod。一般通过构建工具来生成这个文件。</li>
<li>通过 EGG_SERVER_ENV 环境变量指定。<br>一般使用 EGG_SERVER_ENV指定</li>
</ol>
<p>自定义环境</p>
<p>比如，要为开发流程增加集成测试环境 SIT。将 EGG_SERVER_ENV 设置成 sit（并建议设置 NODE_ENV = production），启动时会加载 config/config.sit.js，运行环境变量 app.config.env 会被设置成 sit</p>
<p>应用内获取运行环境</p>
<p>框架提供了变量 app.config.env 来表示应用当前的运行环境。</p>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a><a href="http://eggjs.org/zh-cn/core/unittest.html" target="_blank" rel="noopener">测试</a></h3><p>ctx测试<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">const assert = require(&apos;assert&apos;);</span><br><span class="line">const mock = require(&apos;egg-mock&apos;);</span><br><span class="line"></span><br><span class="line">describe(&apos;test/controller/home.test.js&apos;, () =&gt; &#123;</span><br><span class="line">  let app;</span><br><span class="line">  before(() =&gt; &#123;</span><br><span class="line">    // 创建当前应用的 app 实例</span><br><span class="line">    app = mock.app();</span><br><span class="line">    // 等待 app 启动成功，才能执行测试用例</span><br><span class="line">    return app.ready();</span><br><span class="line">  &#125;);</span><br><span class="line">  it(&apos;should mock ctx.user&apos;, () =&gt; &#123;</span><br><span class="line">        const ctx = app.mockContext(&#123;</span><br><span class="line">                user: &#123;</span><br><span class="line">                name: &apos;fengmk2&apos;,</span><br><span class="line">                &#125;,</span><br><span class="line">            &#125;);</span><br><span class="line">        assert(ctx.user);</span><br><span class="line">        assert(ctx.user.name === &apos;fengmk2&apos;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>http请求测试(controller 测试)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// 使用 async</span><br><span class="line">it(&apos;should redirect&apos;, async () =&gt; &#123;</span><br><span class="line">  await app.httpRequest()</span><br><span class="line">    .get(&apos;/&apos;)</span><br><span class="line">    .expect(302);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>service 测试<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">describe(&apos;get()&apos;, () =&gt; &#123;</span><br><span class="line">  it(&apos;should get exists user&apos;, async () =&gt; &#123;</span><br><span class="line">    // 创建 ctx</span><br><span class="line">    const ctx = app.mockContext();</span><br><span class="line">    // 通过 ctx 访问到 service.user</span><br><span class="line">    const user = await ctx.service.user.get(&apos;fengmk2&apos;);</span><br><span class="line">    assert(user);</span><br><span class="line">    assert(user.name === &apos;fengmk2&apos;);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(&apos;should get null when user not exists&apos;, async () =&gt; &#123;</span><br><span class="line">    const ctx = app.mockContext();</span><br><span class="line">    const user = await ctx.service.user.get(&apos;fengmk1&apos;);</span><br><span class="line">    assert(!user);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p><a href="http://eggjs.org/zh-cn/core/unittest.html" target="_blank" rel="noopener">更多测试</a></p>
<h3 id="多进程架构"><a href="#多进程架构" class="headerlink" title="多进程架构"></a>多进程架构</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">                +--------+          +-------+</span><br><span class="line">                | Master |&lt;--------&gt;| Agent |</span><br><span class="line">                +--------+          +-------+</span><br><span class="line">                ^   ^    ^</span><br><span class="line">               /    |     \</span><br><span class="line">             /      |       \</span><br><span class="line">           /        |         \</span><br><span class="line">         v          v          v</span><br><span class="line">+----------+   +----------+   +----------+</span><br><span class="line">| Worker 1 |   | Worker 2 |   | Worker 3 |</span><br><span class="line">+----------+   +----------+   +----------+</span><br></pre></td></tr></table></figure>
<p>启动顺序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">+---------+           +---------+          +---------+</span><br><span class="line">|  Master |           |  Agent  |          |  Worker |</span><br><span class="line">+---------+           +----+----+          +----+----+</span><br><span class="line">     |      fork agent     |                    |</span><br><span class="line">     +--------------------&gt;|                    |</span><br><span class="line">     |      agent ready    |                    |</span><br><span class="line">     |&lt;--------------------+                    |</span><br><span class="line">     |                     |     fork worker    |</span><br><span class="line">     +-----------------------------------------&gt;|</span><br><span class="line">     |     worker ready    |                    |</span><br><span class="line">     |&lt;-----------------------------------------+</span><br><span class="line">     |      Egg ready      |                    |</span><br><span class="line">     +--------------------&gt;|                    |</span><br><span class="line">     |      Egg ready      |                    |</span><br><span class="line">     +-----------------------------------------&gt;|</span><br></pre></td></tr></table></figure>
<p>消息发送</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">广播消息： agent =&gt; all workers</span><br><span class="line">                  +--------+          +-------+</span><br><span class="line">                  | Master |&lt;---------| Agent |</span><br><span class="line">                  +--------+          +-------+</span><br><span class="line">                 /    |     \</span><br><span class="line">                /     |      \</span><br><span class="line">               /      |       \</span><br><span class="line">              /       |        \</span><br><span class="line">             v        v         v</span><br><span class="line">  +----------+   +----------+   +----------+</span><br><span class="line">  | Worker 1 |   | Worker 2 |   | Worker 3 |</span><br><span class="line">  +----------+   +----------+   +----------+</span><br><span class="line"></span><br><span class="line">指定接收方： one worker =&gt; another worker</span><br><span class="line">                  +--------+          +-------+</span><br><span class="line">                  | Master |----------| Agent |</span><br><span class="line">                  +--------+          +-------+</span><br><span class="line">                 ^    |</span><br><span class="line">     send to    /     |</span><br><span class="line">    worker 2   /      |</span><br><span class="line">              /       |</span><br><span class="line">             /        v</span><br><span class="line">  +----------+   +----------+   +----------+</span><br><span class="line">  | Worker 1 |   | Worker 2 |   | Worker 3 |</span><br><span class="line">  +----------+   +----------+   +----------+</span><br></pre></td></tr></table></figure>
<h3 id="egg-logger-使用"><a href="#egg-logger-使用" class="headerlink" title="egg-logger 使用"></a>egg-logger 使用</h3><ul>
<li><p>自定义transport时一定要传递level参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">class RemoteTransport extends Transport &#123;</span><br><span class="line">  // level 必传</span><br><span class="line">  constructor(&#123; level, app &#125;) &#123;</span><br><span class="line">    super(&#123; level &#125;);</span><br><span class="line">    this._level = level;</span><br><span class="line">    this._app = app;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>自定logger在配置文件中必须传file参数, 必须在customLogger下面配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">config.customLogger = &#123;</span><br><span class="line">  remoteLogger: &#123;</span><br><span class="line">    file: path.join(appInfo.root, &apos;logs/remote.log&apos;),</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>所有logger的错误error方法都被errorLogger的log方法劫持了，所以当我们使用自定义logger的error方法打印时其实是被errorLogger输出了，<br>所以若是自己配置的自定义logger中有其他处理使用error时是不会被触发的</p>
<p>原因见下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Add a logger</span><br><span class="line"> * @param &#123;String&#125; name - logger name</span><br><span class="line"> * @param &#123;Logger&#125; logger - Logger instance</span><br><span class="line"> */</span><br><span class="line">set(name, logger) &#123;</span><br><span class="line">  if (this.has(name)) &#123;</span><br><span class="line">    return;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // redirect ERROR log to errorLogger, except errorLogger itself</span><br><span class="line">  if (name !== &apos;errorLogger&apos;) &#123;</span><br><span class="line">    logger.redirect(&apos;error&apos;, this.errorLogger);</span><br><span class="line">  &#125;</span><br><span class="line">  this[name] = logger;</span><br><span class="line">  super.set(name, logger);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="hack"><a href="#hack" class="headerlink" title="hack"></a>hack</h3><ol>
<li>egg-mongoose 里面挂载在app上的mongoose是个conn对象，base才是mongoose实例</li>
<li>egg 里面的hack, app下面有个serviceClasses属性里面是所有的service的构造函数，所以在拿不到service实例时，<br>可以自己new一个，切记要传入ctx对象，可以通过app.createAnonymousContext创建一个匿名ctx</li>
</ol>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/node/">node</a>
    </span>
    

    </div>

    
  </div>
</article>


    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2018 hello2dj (dj_amazing@sina.com)
    
  </p>
</footer>
    
  </div>
</div>
</body>
</html>